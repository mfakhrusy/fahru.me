<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Understanding Asynchronous JavaScript - My Tech Blog</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="./assets/airfoil-simulation/airfoil-simulation.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Source+Code+Pro&display=swap" rel="stylesheet">
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
</head>
<body>

    <header class="container">
        <div class="header-content">
            <h1><a href="/">std::fahru's finite space</a></h1>
            <p class="subtitle">An assortment of emotions about the state of my mind</p>
        </div>
    </header>

    <main class="container container-post">
        <article class="post-full">
            <header class="post-header">
                <h2>This is a work in progress of me writing an article about building an airfoil simulator (in Rust)</h2>
                <!-- <p class="post-meta">Published on July 11, 2025 by yours truly</p> -->
            </header>

            <div class="post-content">
                <p>One concept that may not be generally known among the general masses is the concept of airfoils. What are those, really? Are those related to airplane? Yes!</p>
                <figure>
                    <img src="./assets/airfoil-simulation/airfoil_from_wiki.svg" alt="Diagram of an airfoil" class="content-image">
                    <figcaption>
                        <small>
                            Airfoil. By <a href="//commons.wikimedia.org/wiki/User:Ariadacapo" title="User:Ariadacapo" target="_blank" rel="noreferrer noopener">Olivier Cleynen</a> (<span class="int-own-work" lang="en">Own work</span>), <a href="http://creativecommons.org/publicdomain/zero/1.0/deed.en" title="Creative Commons Zero, Public Domain Dedication" target="_blank" rel="noreferrer noopener">CC0</a>. <a href="https://commons.wikimedia.org/w/index.php?curid=16100403" target="_blank" rel="noreferrer noopener">View on Wikimedia Commons</a>
                        </small>
                    </figcaption>
                </figure>
                <p>To understand the picture above, you need to imagine cutting an airplane wing and look at it from the side, which is called the cross-section of the wing.</p>
                <p>Many modern airplanes are using proprietary airfoil designs, but there is a great source of open-source airfoils that we can use to create our simulation. There's a website called <a href="https://web.archive.org/web/20250325091354/http://airfoiltools.com/" target="_blank" rel="noreferrer noopener">Airfoil Tools</a> that we can use to download many airfoil data.</p>
                <p>To start with this project, I'm going to also go over about the basic ideas of computational fluid dynamics: what is it, and how does it work with airfoils?</p>
                <p>First, an initial question: What does it mean by "simulating" an airfoil? Simulation usually involves creating a digital representation of something to make it easier to understand or demonstrate. That means, in the case of airfoils, we will simulate real airfoils in a virtual environment.</p>
                <p>Let us start with a simple tool to visualize an airfoil from a series of points.</p>
                <div class="airfoil-visualizer">
                    <!-- Header -->
                    <div class="visualizer-header">
                        <h1 class="visualizer-title">Airfoil Data Visualizer</h1>
                    </div>

                    <!-- Controls -->
                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="file-upload" class="control-label">Upload .dat File</label>
                            <input type="file" id="file-upload" accept=".dat" class="file-input">
                        </div>
                    </div>

                    <!-- Canvas for Drawing -->
                    <div class="canvas-container">
                        <canvas id="airfoil-canvas" class="airfoil-canvas"></canvas>
                    </div>

                    <!-- Log Output -->
                    <div class="log-section">
                        <h2 class="log-title">Parser Log</h2>
                        <textarea id="log-output" readonly class="log-output"></textarea>
                    </div>
                </div>
           </div>
        </article>
    </main>

    <footer class="container">
        <p>&#8508; Hi, there.</p>
    </footer>

    <script>
        // --- DOM Element References ---
        const fileInput = document.getElementById('file-upload');
        const canvas = document.getElementById('airfoil-canvas');
        const logOutput = document.getElementById('log-output');
        const ctx = canvas.getContext('2d');

        let lastParsedPoints = [];

        // --- Logging Utility ---
        function log(message) {
            console.log(message);
            logOutput.value += message + '\n';
            logOutput.scrollTop = logOutput.scrollHeight; // Auto-scroll
        }

        function clearLogs() {
            logOutput.value = '';
        }

        /**
         * Parses airfoil data from a string.
         * @param {string} data - The string content of the .dat file.
         * @returns {{points: {x: number, y: number}[], errorCount: number}|null} - The parsed points array or null on failure.
         */
        function parseAirfoilDat(data) {
            log(`Parsing airfoil data...`);
            
            const points = [];
            let lineCount = 0;
            let errorCount = 0;

            const lines = data.split(/\r?\n/);

            for (const line of lines) {
                lineCount++;
                const trimmed = line.trim();

                // Skip empty lines and comments
                if (trimmed === '' || trimmed.startsWith('#') || trimmed.startsWith(';')) {
                    continue;
                }
                
                // The first line might be the name, but we often ignore it and use the user-provided one.
                // Some formats have coordinate counts, which we can also ignore by checking for non-numeric parts.
                const parts = trimmed.split(/\s+/);
                
                if (parts.length >= 2) {
                    const x = parseFloat(parts[0]);
                    const y = parseFloat(parts[1]);

                    if (!isNaN(x) && !isNaN(y)) {
                        points.push({ x, y });
                    } else {
                        // This might be a header line like "NACA 2412" or a line with text.
                        // We log it but don't count it as a hard error if it's early in the file.
                        if(points.length > 0) { // Only count as error if we've already started parsing points
                           errorCount++;
                           log(`Warning: Could not parse line ${lineCount}: '${trimmed}'`);
                        } else {
                           log(`Info: Skipping header line ${lineCount}: '${trimmed}'`);
                        }
                    }
                } else if (trimmed !== '') {
                    errorCount++;
                    log(`Warning: Invalid format on line ${lineCount}: '${trimmed}'`);
                }
            }

            log(`Parsed ${points.length} points from ${lineCount} lines (${errorCount} errors)`);
            
            if (points.length === 0) {
                log("Error: No valid points found in airfoil data.");
                return null;
            }

            return { points, errorCount };
        }

        /**
         * Draws the airfoil shape on the canvas.
         * @param {{x: number, y: number}[]} points - An array of airfoil coordinates.
         */
        function drawAirfoil(points) {
            if (!points || points.length === 0) {
                // Clear canvas if no points
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            };

            // Ensure canvas has a resolution for drawing
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Find data bounds to scale and center the drawing
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            points.forEach(p => {
                minX = Math.min(minX, p.x);
                maxX = Math.max(maxX, p.x);
                minY = Math.min(minY, p.y);
                maxY = Math.max(maxY, p.y);
            });

            const dataWidth = maxX - minX;
            const dataHeight = maxY - minY;

            // Add padding
            const padding = 50;
            const canvasWidth = canvas.width - 2 * padding;
            const canvasHeight = canvas.height - 2 * padding;

            // Calculate scale factor, keeping aspect ratio
            const scaleX = canvasWidth / dataWidth;
            const scaleY = canvasHeight / dataHeight;
            const scale = Math.min(scaleX, scaleY) * 0.9; // Use 90% of available space

            const offsetX = padding + (canvasWidth - dataWidth * scale) / 2;
            const offsetY = padding + (canvasHeight - dataHeight * scale) / 2;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.strokeStyle = '#0ea5e9'; // A nice blue color
            ctx.lineWidth = 2;

            points.forEach((p, index) => {
                // Transform point from data coordinates to canvas coordinates
                const canvasX = (p.x - minX) * scale + offsetX;
                const canvasY = canvas.height - ((p.y - minY) * scale + offsetY); // Flip Y-axis

                if (index === 0) {
                    ctx.moveTo(canvasX, canvasY);
                } else {
                    ctx.lineTo(canvasX, canvasY);
                }
            });

            ctx.stroke();
            
            // Optional: Draw chord line
            const startPoint = points[0];
            const endPoint = points[points.length - 1];
            if (Math.abs(startPoint.y - endPoint.y) < 0.01) { // Heuristic for closed trailing edge
                 ctx.closePath();
                 ctx.fillStyle = 'rgba(14, 165, 233, 0.1)';
                 ctx.fill();
            }

            log("Successfully rendered airfoil on canvas.");
        }

        // --- Event Listeners ---
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = e.target.result;
                clearLogs();
                const result = parseAirfoilDat(data);
                if (result) {
                    lastParsedPoints = result.points;
                    drawAirfoil(lastParsedPoints);
                } else {
                    lastParsedPoints = [];
                    drawAirfoil([]); // Clear canvas on error
                }
            };
            reader.onerror = () => {
                log(`Error reading file: ${reader.error}`);
            };
            reader.readAsText(file);
        });
        
        // Redraw on window resize
        window.addEventListener('resize', () => {
            drawAirfoil(lastParsedPoints);
        });

        // Initial state message
        log("Ready. Please select a .dat file to begin.");
    </script>
</body>
</html>


